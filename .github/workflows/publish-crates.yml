name: Publish to crates.io

on:
  push:
    tags:
      - 'rexis-macros-v*'
      - 'rexis-llm-v*'
      - 'rexis-rag-v*'
      - 'rexis-graph-v*'
      - 'rexis-v*'
  workflow_dispatch:
    inputs:
      crate:
        description: 'Which crate to publish'
        required: true
        type: choice
        options:
          - rexis-macros
          - rexis-llm
          - rexis-rag
          - rexis-graph
          - rexis
          - all

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    name: Publish Crates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-features --workspace --all-targets || true

      - name: Run tests
        run: cargo test --lib -p rexis-llm -p rexis-macros

      - name: Determine which crate to publish
        id: determine-crate
        env:
          EVENT_NAME: ${{ github.event_name }}
          WORKFLOW_INPUT: ${{ github.event.inputs.crate }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          if [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
            CRATE="$WORKFLOW_INPUT"
          else
            if [[ "$TAG_NAME" == rexis-macros-v* ]]; then
              CRATE="rexis-macros"
            elif [[ "$TAG_NAME" == rexis-llm-v* ]]; then
              CRATE="rexis-llm"
            elif [[ "$TAG_NAME" == rexis-rag-v* ]]; then
              CRATE="rexis-rag"
            elif [[ "$TAG_NAME" == rexis-graph-v* ]]; then
              CRATE="rexis-graph"
            elif [[ "$TAG_NAME" == rexis-v* ]]; then
              CRATE="rexis"
            else
              CRATE="all"
            fi
          fi
          echo "crate=$CRATE" >> $GITHUB_OUTPUT
          echo "Publishing: $CRATE"

      - name: Publish rexis-macros
        if: steps.determine-crate.outputs.crate == 'rexis-macros' || steps.determine-crate.outputs.crate == 'all'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          echo "Publishing rexis-macros to crates.io..."
          cd crates/rexis-macros
          cargo publish --no-verify

      - name: Wait for rexis-macros to propagate
        if: steps.determine-crate.outputs.crate == 'all'
        run: |
          echo "Waiting 90 seconds for rexis-macros to be available on crates.io..."
          sleep 90

      - name: Publish rexis-llm
        if: steps.determine-crate.outputs.crate == 'rexis-llm' || steps.determine-crate.outputs.crate == 'all'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          echo "Publishing rexis-llm to crates.io..."
          cd crates/rexis-llm
          cargo publish --no-verify

      - name: Wait for rexis-llm to propagate
        if: steps.determine-crate.outputs.crate == 'all'
        run: |
          echo "Waiting 90 seconds for rexis-llm to be available on crates.io..."
          sleep 90

      - name: Publish rexis-rag
        if: steps.determine-crate.outputs.crate == 'rexis-rag' || steps.determine-crate.outputs.crate == 'all'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          echo "Publishing rexis-rag to crates.io..."
          cd crates/rexis-rag
          cargo publish --no-verify

      - name: Wait for rexis-rag to propagate
        if: steps.determine-crate.outputs.crate == 'all'
        run: |
          echo "Waiting 90 seconds for rexis-rag to be available on crates.io..."
          sleep 90

      - name: Publish rexis-graph
        if: steps.determine-crate.outputs.crate == 'rexis-graph' || steps.determine-crate.outputs.crate == 'all'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          echo "Publishing rexis-graph to crates.io..."
          cd crates/rexis-graph
          cargo publish --no-verify

      - name: Wait for rexis-graph to propagate
        if: steps.determine-crate.outputs.crate == 'all'
        run: |
          echo "Waiting 90 seconds for rexis-graph to be available on crates.io..."
          sleep 90

      - name: Publish rexis
        if: steps.determine-crate.outputs.crate == 'rexis' || steps.determine-crate.outputs.crate == 'all'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          echo "Publishing rexis umbrella crate to crates.io..."
          cd crates/rexis
          cargo publish --no-verify

      - name: Create GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          body: |
            ## Rexis - Agentic AI Framework for Rust

            Published to crates.io:
            - rexis: https://crates.io/crates/rexis (umbrella crate)
            - rexis-llm: https://crates.io/crates/rexis-llm
            - rexis-rag: https://crates.io/crates/rexis-rag
            - rexis-graph: https://crates.io/crates/rexis-graph
            - rexis-macros: https://crates.io/crates/rexis-macros

            ### Quick Start
            ```toml
            [dependencies]
            rexis = { version = "0.1", features = ["full"] }
            ```

            ### Tagline
            *"Rule your agents, connect your intelligence"*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
